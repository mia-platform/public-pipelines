name: Image Building

on:
  push:
    branches:
    - "main"
    - "feat/action"
    paths:
    - "containers/**"
    - ".github/workflows/**"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Calculate file differences
      id: diff
      uses: tj-actions/changed-files@v37
      with:
        files_yaml: |
          containers:
          - containers/**
          workflows:
          - ./.github/workflows/**
    - name: Generate Matrix
      id: matrix
      run: |
        output_matrix="[]"
        base_changed=false
        for path in ${{steps.diff.outputs.workflows_all_changed_and_modified_files}}; do
          filename=$(basename "${path}")
          case ${filename%.*} in
            build-base)
              base_changed=true
            ;;
            build-node|build-sysdig|build-go|build-docker)
              output_matrix=$(echo "${output_matrix}" | jq --arg path "${path}" -c '. += [$path] | unique')
            ;;
          esac
        done
        for path in ${{steps.diff.outputs.containers_all_changed_and_modified_files}}; do
          foldername=$(echo $path | cut -d / -f 2)
          case ${foldername%.*} in
            base)
              base_changed=true
            ;;
            docker)
              output_matrix=$(echo "${output_matrix}" | jq -c '. += ["./.github/workflows/build-docker.yml"] | unique')
            ;;
            go)
              output_matrix=$(echo "${output_matrix}" | jq -c '. += ["./.github/workflows/build-go.yml"] | unique')
            ;;
            node)
              output_matrix=$(echo "${output_matrix}" | jq -c '. += ["./.github/workflows/build-node.yml"] | unique')
            ;;
            sysdig)
              output_matrix=$(echo "${output_matrix}" | jq -c '. += ["./.github/workflows/build-sysdig.yml"] | unique')
            ;;
          esac
        done
        echo "jobs_matrix=${output_matrix}" >> $GITHUB_OUTPUT
        echo "base_changed=${base_changed}" >> $GITHUB_OUTPUT
    outputs:
      matrix: ${{ steps.matrix.outputs.jobs_matrix }}
      base_changed: ${{ steps.matrix.outputs.base_changed }}

  rebuild-base:
    needs: generate-matrix
    if: needs.generate-matrix.outputs.base_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: print
        run: |
          echo "running base image build workflow"

  rebuild-images:
    needs: generate-matrix
    runs-on: ubuntu-latest
    if: needs.generate-matrix.outputs.base_changed == 'false'
    steps:
    - name: print
      run: |
        echo ${{ needs.generate-matrix.outputs.matrix }}
        echo ${{ needs.generate-matrix.outputs.base_changed }}
