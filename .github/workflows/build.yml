name: Image Building

on:
  workflow_dispatch:
  schedule:
  - cron: "0 0 1,15 * *"

jobs:
  rebuild-base:
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1"
          build_args: ""
    with:
      image_path: containers/base
      image_name: base-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-docker:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1"
          build_args: ""
    with:
      image_path: containers/docker
      image_name: docker-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-go:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1.21"
          build_args: |
            GO_VERSION=1.21.13
            GO_CHECKSUM=502fc16d5910562461e6a6631fb6377de2322aad7304bf2bcd23500ba9dab4a7
            GO_CHECKSUM_ARM=2ca2d70dc9c84feef959eb31f2a5aac33eefd8c97fe48f1548886d737bffabd4
        - tag: "1.22"
          build_args: |
            GO_VERSION=1.22.7
            GO_CHECKSUM=fc5d49b7a5035f1f1b265c17aa86e9819e6dc9af8260ad61430ee7fbe27881bb
            GO_CHECKSUM_ARM=ed695684438facbd7e0f286c30b7bc2411cfc605516d8127dc25c62fe5b03885
        - tag: "1.23"
          build_args: ""
    with:
      image_path: containers/go
      image_name: golang-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-kubernetes:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1.28"
          build_args: |
            KUBECTL_VERSION=v1.28.14
            KUBECTL_CHECKSUM=e1e8c08f7fc0b47e5d89422e573c3a2e658d95f1ee0c7ea6c8cb38f37140e607
            KUBECTL_CHECKSUM_ARM=42b813cdde7d5e04593c219a11a07f0866dd2492b7447a700870af1461ce2d8d
        - tag: "1.29"
          build_args: |
            KUBECTL_VERSION=v1.29.9
            KUBECTL_CHECKSUM=7b0de2466458cc3c12cf8742dc800c77d4fa72e831aa522df65e510d33b329e2
            KUBECTL_CHECKSUM_ARM=0fc73b3e4bf5395e0182ae62df24a96d5870baa44fabcc50b5eb2d8dcf22dd78
        - tag: "1.30"
          build_args:  |
            KUBECTL_VERSION=v1.30.5
            KUBECTL_CHECKSUM=b8aa921a580c3d8ba473236815de5ce5173d6fbfa2ccff453fa5eef46cc5ee7a
            KUBECTL_CHECKSUM_ARM=efc594857f9255fc33bcda9409b8862a3b47ce5f4e09d51c3427b85dd769b9b9
        - tag: "1.31"
          build_args: ""
    with:
      image_path: containers/kubernetes
      image_name: kubernetes-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-node:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "18"
          build_args: |
            NODE_VERSION=v18.18.2
            NODE_CHECKSUM=75aba25ae76999309fc6c598efe56ce53fbfc221381a44a840864276264ab8ac
            NODE_CHECKSUM_ARM=2e630e18548627f61eaf573233da7949dc0a1df5eef3f486fa9820c5f6c121aa
        - tag: "20"
          build_args: |
            NODE_VERSION=v20.17.0
            NODE_CHECKSUM=a24db3dcd151a52e75965dba04cf1b3cd579ff30d6e0af9da1aede4d0f17486b
            NODE_CHECKSUM_ARM=7ebbb636c23f89dbf66648e227fbd0998ce33db4c588520256425102d97dd1a4
        - tag: "22"
          build_args: ""
    with:
      image_path: containers/node
      image_name: node-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-sysdig:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1"
          build_args: ""
    with:
      image_path: containers/sysdig
      image_name: sysdig-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit
