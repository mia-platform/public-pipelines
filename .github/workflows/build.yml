name: Image Building

on:
  workflow_dispatch:
  schedule:
  - cron: "0 0 1,15 * *"

jobs:
  rebuild-base:
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1"
          build_args: ""
    with:
      image_path: containers/base
      image_name: base-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-docker:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1"
          build_args: ""
    with:
      image_path: containers/docker
      image_name: docker-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-go:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1.23"
          # fix GOLANGCI version to 1x until 1.25 to avoid breaking changes in current pipelines
          build_args: |
            GO_VERSION=1.23.9
            GO_CHECKSUM=de03e45d7a076c06baaa9618d42b3b6a0561125b87f6041c6397680a71e5bb26
            GO_CHECKSUM_ARM=3dc4dd64bdb0275e3ec65a55ecfc2597009c7c46a1b256eefab2f2172a53a602
            GOLANGCI_VERSION=1.64.8
            LINT_CHECKSUM=b6270687afb143d019f387c791cd2a6f1cb383be9b3124d241ca11bd3ce2e54e
            LINT_CHECKSUM_ARM=a6ab58ebcb1c48572622146cdaec2956f56871038a54ed1149f1386e287789a5
        - tag: "1.24"
          build_args: |
            GOLANGCI_VERSION=1.64.8
            LINT_CHECKSUM=b6270687afb143d019f387c791cd2a6f1cb383be9b3124d241ca11bd3ce2e54e
            LINT_CHECKSUM_ARM=a6ab58ebcb1c48572622146cdaec2956f56871038a54ed1149f1386e287789a5
    with:
      image_path: containers/go
      image_name: golang-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-kubernetes:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1.29"
          build_args: |
            KUBECTL_VERSION=v1.29.15
            KUBECTL_CHECKSUM=3473e14c7b024a6e5403c6401b273b3faff8e5b1fed022d633815eb3168e4516
            KUBECTL_CHECKSUM_ARM=a41984dc0ff34ee05f1283ebd9b3121c003b3469b97214738246faa5b6788f7c
        - tag: "1.30"
          build_args:  |
            KUBECTL_VERSION=v1.30.12
            KUBECTL_CHECKSUM=261a3c4eb12e09207b9e08f0b43d547220569317ed8d7a22638572100ace5b80
            KUBECTL_CHECKSUM_ARM=1af7e16a143c283a29821a09f5a006aacf0fe8368bc18adbd40588ba395e0352
        - tag: "1.31"
          build_args: |
            KUBECTL_VERSION=v1.31.8
            KUBECTL_CHECKSUM=be0aa44a50a9aada4e9402e361ffb0d5bb1fd4f6950751399fcaf3b8b936a746
            KUBECTL_CHECKSUM_ARM=bd76445943b22d976bdbd1d0709e4bcb5f0081cc02c10139f4b3e5e209dc3019
        - tag: "1.32"
          build_args: ""
    with:
      image_path: containers/kubernetes
      image_name: kubernetes-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-node:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "18"
          build_args: |
            NODE_VERSION=v18.20.8
            NODE_CHECKSUM=5467ee62d6af1411d46b6a10e3fb5cacc92734dbcef465fea14e7b90993001c9
            NODE_CHECKSUM_ARM=224e569dbe7b0ea4628ce383d9d482494b57ee040566583f1c54072c86d1116b
        - tag: "20"
          build_args: |
            NODE_VERSION=v20.19.1
            NODE_CHECKSUM=b6c4cedfc81fc544b9993bc8a3628b5c0aa7a169fbaa293460abc0418d0fabb6
            NODE_CHECKSUM_ARM=0f6a0aaca9181de98c0a11d97b8873aa5ddd87e0f48385fc89697e25c3675a18
        - tag: "22"
          build_args: ""
    with:
      image_path: containers/node
      image_name: node-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit

  rebuild-sysdig:
    needs: rebuild-base
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        params:
        - tag: "1"
          build_args: ""
    with:
      image_path: containers/sysdig
      image_name: sysdig-pipeline
      image_tag: ${{ matrix.params.tag }}
      build_args: ${{ matrix.params.build_args }}
    secrets: inherit
